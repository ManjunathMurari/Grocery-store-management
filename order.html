<!DOCTYPE html>
<html>
<head>
    <title>GSMS - New Order</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body style="background-color: #f8f9fa;">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <a class="navbar-brand" href="index.html">Grocery Store System</a>
    </nav>
    <div class="container">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3>New Order</h3>
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="customerName" class="form-control" placeholder="Enter customer name">
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <label>Product</label>
                        <select id="productDropdown" class="form-control"></select>
                    </div>
                    <div class="col-md-3">
                        <label>Price</label>
                        <input type="text" id="productPrice" class="form-control" readonly>
                    </div>
                    <div class="col-md-2">
                        <label>Quantity</label>
                        <input type="number" id="productQty" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button id="addItem" class="btn btn-success btn-block">Add Item</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table" id="orderTable">
                    <thead>
                        <tr><th>Product</th><th>Price</th><th>Quantity</th><th>Total</th><th>Action</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="text-right">
                    <h4>Grand Total: <span id="grandTotal">0.00</span> Rs</h4>
                    <button id="saveOrder" class="btn btn-primary btn-lg mt-3">Save Order</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        $(function () {
            var productsList = [];
            
            // 1. Fetch products for dropdown
            $.get('http://127.0.0.1:5000/getProducts', function (response) {
                productsList = response;
                var options = '<option value="">-- Select Product --</option>';
                $.each(response, function(index, p) {
                    options += '<option value="'+p.product_id+'">'+p.name+'</option>';
                });
                $("#productDropdown").html(options);
            });

            // 2. Auto-fill price
            $("#productDropdown").change(function() {
                var id = $(this).val();
                var product = productsList.find(p => p.product_id == id);
                $("#productPrice").val(product ? product.price_per_unit : "");
            });

            // 3. Add item to table
            $("#addItem").click(function() {
                var id = $("#productDropdown").val();
                var name = $("#productDropdown option:selected").text();
                var price = parseFloat($("#productPrice").val());
                var qty = parseFloat($("#productQty").val());
                
                if(!id || isNaN(qty) || qty <= 0) return alert("Select a product and valid quantity");

                var total = price * qty;
                var row = `<tr>
                    <td>${name}<input type="hidden" class="cart-product-id" value="${id}"></td>
                    <td>${price}</td>
                    <td><input type="number" class="form-control cart-qty" value="${qty}" readonly></td>
                    <td class="cart-total">${total.toFixed(2)}</td>
                    <td><button class="btn btn-danger btn-sm remove-item">X</button></td>
                </tr>`;
                
                $("#orderTable tbody").append(row);
                updateGrandTotal();
            });

            // 4. Remove item
            $(document).on("click", ".remove-item", function() {
                $(this).closest('tr').remove();
                updateGrandTotal();
            });

            function updateGrandTotal() {
                var grandTotal = 0;
                $(".cart-total").each(function() {
                    grandTotal += parseFloat($(this).text());
                });
                $("#grandTotal").text(grandTotal.toFixed(2));
            }

            // 5. FINAL SAVE ORDER LOGIC
            $("#saveOrder").on("click", function () {
                var customer = $("#customerName").val();
                var total = $("#grandTotal").text();
                var details = [];

                // Scrape table rows
                $("#orderTable tbody tr").each(function () {
                    var row = $(this);
                    details.push({
                        product_id: row.find('.cart-product-id').val(),
                        quantity: row.find('.cart-qty').val(),
                        total_price: row.find('.cart-total').text()
                    });
                });

                if (!customer) return alert("Please enter Customer Name");
                if (details.length === 0) return alert("Please add at least one product to the order.");

                var payload = {
                    'customer_name': customer,
                    'grand_total': total,
                    'order_details': details
                };

                $.post('http://127.0.0.1:5000/insertOrder', {
                    'data': JSON.stringify(payload)
                }, function (response) {
                    alert("Order Saved Successfully! Order ID: " + response.order_id);
                    location.reload(); 
                }).fail(function() {
                    alert("Error: Backend is not responding.");
                });
            });
        });
    </script>
</body>
</html>
